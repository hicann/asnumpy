# 📘 AsNumpy--昇腾NPU原生Numpy

在人工智能与深度学习飞速发展的当下，高效、友好的计算工具成为开发者们的迫切需求。随着算力需求的不断攀升，专用计算芯片及相应的软件生态愈发重要。值得注意的是，**Python 目前已以 26.14% 的占比成为 Tiobe 历史上最受欢迎的编程语言**，在科学计算、数据分析与人工智能领域均占据主导地位。而在 Python 生态中，**Numpy 是基石性的数学运算库**，为后续的诸多深度学习框架和工具提供了底层支撑。

> ❗ 为进一步提升开发者在昇腾 NPU 上的计算体验，哈尔滨工业大学计算学部苏统华教授团队联合华为团队打造了 **昇腾 NPU 原生 Numpy —— AsNumpy**。

AsNumpy 是一款 **深度支持昇腾 NPU 并高度兼容 Numpy 接口的轻量级 Python 数学运算库**。  
它基于 **pybind11** 封装华为 Ascend C 算子库，使用户可以在 Python 中像使用 Numpy 一样在 NPU 上创建、操作张量，并实现与主机端 `numpy.ndarray` 的双向拷贝。  

---
## ✨核心优势

与 Numpy 接口高度兼容，几乎无需额外学习成本，即可释放昇腾 NPU 的高效原生计算能力。

---
## 💡设计理念

### 数据结构 NPUArray

`NPUArray` 是 AsNumpy 的核心数据结构，设计理念主要体现在以下三个方面：

#### 🔄 兼容性
在 Python 层完全兼容 **Numpy API**，为用户提供与 `ndarray` 无缝衔接的体验。  
这意味着你可以像使用 **Numpy** 一样使用 `NPUArray`。

#### 📦 内部封装
`NPUArray` 内部封装了 `dtype`、`shape` 等基本信息，以及底层的数据 `aclTensor`。  
用户在 Python 层操作时，无需关心底层复杂的细节。

#### 🗂️ 资源管理
`NPUArray` 提供了方便的构造函数，并且在对象不再使用时，会自动调用析构函数释放资源。  
这种设计避免了手动管理内存可能引发的内存泄漏问题，使用户能够更加专注于算法逻辑。

---

### **计算功能** 模块

AsNumpy 的计算功能模块设计分为 **功能模块** 与 **基础模块** 两大类，目前已实现约 **113 个 API**（含十几个功能尚不完全支持的接口，以及若干对参数 `shape` 有特殊限制的接口）。此外，还有 **10 个 API** 因代码问题尚未合并，以及 **11 个内部 `utils` 接口** 仅供开发者使用。  

计算功能模块设计示意图如下所示：

![计算功能模块设计图](docs/images/功能模块.png)

#### 📊 具体功能
- **数学模块（math）**  
  - 参考 Numpy 与 CuPy，共约 94 个接口，目前已实现 **73 个**。  
  - 涵盖三角函数、指数运算、对数运算等常见数学计算。  

- **随机抽样模块（random）**  
  - 共约 80 个接口，目前实现 **10 个**。  
  - 主要难点在于概率分布相关的计算逻辑复杂。  

- **线性代数模块（linalg）**  
  - 共约 22 个接口，目前已合并 **10 个**。  
  - 其余 API 将在梳理整理后逐步合并。  

- **逻辑函数模块（logic）**  
  - 约 10 个接口，对标 Numpy 的逻辑运算功能。  

- **傅里叶变换模块（fft）**  
  - 约 15 个接口，实现常见的离散傅里叶变换操作。  

- **数组创建模块（creation）**  
  - 约 25 个接口，包括 `zeros`、`ones`、`arange` 等常用 API。  

- **输入输出模块（io）**  
  - 约 10 个接口，提供数据的读写支持，如 `load`、`save`。  

- **拓展模块（extension）**  
  - 约 10 个接口。  
  - 除标准 API 外，还支持开发者自定义 Ascend C 算子。  

#### 🧩 基础模块
- **辅助工具模块（utils）**  
  - 约 10 个接口。  
  - 提供各种基础工具函数，支持项目内部开发使用。  

- **内存池模块（memory）**  
  - 约 10 个接口。  
  - 通过优化 NPU 内存的申请与释放，降低调用开销，提升性能。  

- **数据类型模块（dtypes）**  
  - 约 15 个接口。  
  - 提供完整的 `aclDataType` 类型支持，并与 Numpy 类型系统保持兼容。  

📌 **总结**  
- 目前 AsNumpy 共规划约 **260 个接口**。  
- 已实现并合并：**113 个**  
- 待合并：**10 个**  
- 内部 utils：**11 个**  
- 数学模块是主要进展，随机模块由于复杂性进度相对缓慢，线性代数模块则在整理后逐步合并。  

---

### 🚀 NPU 扩展功能模块

AsNumpy 在支持 NPU 算力的过程中，面临算子覆盖率不足的问题。为此，引入了 **NPU 扩展功能模块**，通过自研与开源算子库结合的方式，提升 API 覆盖率与性能。

NPU扩展功能模块设计示意图如下所示：

![NPU扩展功能模块设计图](docs/images/NPU扩展功能模块.png)

#### ⚠️ 现有问题
- AsNumpy 需要封装 CANN 内置算子。  
- CANN 内置算子无法覆盖 NumPy 的全部 API。  

#### 💡 解决方案
- 对缺失的算子进行手动开发。  
- 借助 **OpenBOAT** 开源算子库来补齐算子。  
- 优先安排缺失算子的开发计划。  

#### 🌟 价值体现
- **OpenBOAT** 为 AsNumpy 提供算子支持。  
- 推动 AsNumpy 兼容更多 NumPy API。  
- 加速 AsNumpy 项目的落地与完善。  

> 📌 **说明**：  
> OpenBOAT 是由 **哈尔滨工业大学计算学部苏统华教授团队** 设计的 Ascend C 算子仓库，能够为 AsNumpy 提供灵活的算子扩展支持。

---
## 📐 使用方式对比：Numpy vs AsNumpy
> 💻 下面展示一组代码示例，帮助开发者直观对比 **Numpy** 与 **AsNumpy** 的使用差异。

### 使用 **Numpy** 实现矩阵元素乘积与求和
```python 
import numpy as np
rows = 20000  
cols = 20000 
m1 = np.random.normal(...)
m2 = np.random.normal(...)
elementwise_product = np.multiply(m1, m2)
total_sum = np.sum(elementwise_product) 
```

### 使用 **AsNumpy** 实现矩阵元素乘积与求和
```python
import asnumpy as ap 
m1_npu = ap.from_numpy(m1)
m2_npu = ap.from_numpy(m2)
elementwise_product = ap.multiply(m1_npu, m2_npu)
total_sum = ap.sum(elementwise_product) 
```

---
## 🚀 已支持功能

| 功能                                         | 状态     |
| -------------------------------------------- | -------- |
| AscendCL 系统配置与运行时管理                 | ✅ 已完成 |
| NPUArray 数据结构                            | ✅ 已完成 |
| 基础创建函数：`ones`、`zeros`                 | ✅ 已完成 |
| 与 Numpy 双向拷贝（`to_numpy`、`from_numpy`） | ✅ 已完成 |
| 完整 Numpy API 兼容                          | 🚧 进行中 |
| 更多逐元素 / 规约算子                        | 🚧 进行中 |


---

## 📊 性能测试

以不同形状的张量作为输入，针对 **AsNumpy 与 Numpy** 进行背对背测试。  
示例：`add()` 函数，数据类型为 `int32`，测试时间单位为秒（小数点后四位）。  

> 可以看出，在一定规模下，NPU 的原生计算能力能得到充分释放。  

| 张量形状             | AsNumpy 执行时间 (s) | Numpy 执行时间 (s) | 加速比   |
| -------------------- | -------------------- | ------------------ | ------- |
| (100, 100, 10)       | 0.0001               | 0.0001             | 0.94×   |
| (1000, 100, 10)      | 0.0001               | 0.0013             | 12.19× |
| (1000, 1000, 10)     | 0.0004               | 0.0244             | 66.05× |
| (1000, 1000, 100)    | 0.0024               | 0.2681             | 112.11× |


---

## ⚙️ 使用说明

本仓库目前支持用户以 **源代码编译安装** 的方式使用，后续将以 `whl` 包形式提供预编译版本。  

**环境要求**：  
- 操作系统：Linux  
- 编译工具：`gcc >= 11.2`、`ninja-build`  
- Python：`>= 3.9`  
- 硬件环境：昇腾 910B  
- 软件环境：`CANN 8.2.RC1.alpha003` 已安装  

**用户使用方式**：
```bash
git clone --recursive https://gitcode.com/cann/asnumpy.git
cd asnumpy
pip install .
```

**开发者使用方式**：
```bash
git clone --recursive https://gitcode.com/cann/asnumpy.git
cd asnumpy
mkdir build && cd build
cmake .. -GNinja && ninja
```
> 构建产物将位于 `asnumpy/lib` 子文件夹下。  
开发者可在 `src` 与 `include` 文件夹中开发新的 API。


---

## 🧭 下一步计划（欢迎贡献）

| 阶段       | 目标                                                                 |
| ---------- | -------------------------------------------------------------------- |
| **v0.2**   | 内部代码 **面向对象** 重构，结构更清晰                                |
| **v0.3**   | 支持逐元素 & 规约算子：`sum`、`matmul` …                              |
| **v1.0**   | **兼容 Numpy 使用率前 100 的 API，支持大部分 Numpy 算法迁移至 AsNumpy** |
| **v2.0**   | **扩展 Ascend C 算子库，支持使用自定义 Ascend C 算子**                |


---

## 👥 贡献者

- 哈尔滨工业大学苏统华老师团队  
- 王甜甜老师团队  
- 华为 CANN 团队  


---

## 📄 开源协议

Apache License, Version 2.0 © 2024-2025 AsNumpy 贡献者
